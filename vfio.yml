#- name: Enable iommu in boot efi
#  replace:
#   path: /boot/efi/loader/entries/Pop_OS-current.conf
#   regexp: ' ro quiet loglevel='
#   replace: ' ro quiet amd_iommu=on loglevel='
#   owner: root
#   group: root
#   #backup: yes
#  become: yes
#  register: update_grub

#- name: set up sudo for ansible user
#  copy:
#    src: files/vfio/vfio-pci.sh
#    dest: /etc/initramfs-tools/scripts/init-top/bind_vfio.sh
#    owner: root
#    group: root
#    mode: 0755
#  register: initramfs
- name: copy passthrough_installer
  copy:
    src: files/vfio/passthrough_installer.sh
    dest: /home/sky/passthrough_installer.sh
    owner: sky
    group: sky
    mode: 0755
  register: passthough 

- name: runs passthrough_installer
  script: /home/sky/passthrough_installer.sh
  become: yes
  become_user: ansibledaemon
  when: passthough.changed

- name: looking glass MEM file
  copy:
    src: files/vfio/10-looking-glass.conf
    dest: /etc/tmpfiles.d/10-looking-glass.conf
    owner: root
    group: root
    mode: 0755
  register: systemdtmpfiles 

- name: activate looking glass tmpfiles
  shell: systemd-tmpfiles --create /etc/tmpfiles.d/10-looking-glass.conf
  become: yes
  become_user: root
  when: systemdtmpfiles.changed

- name: Enable hugepages
  blockinfile:
   path: /etc/sysctl.conf
   block: |
    vm.nr_hugepages=8192
    vm.hugetlb_shm_group=48
   backup: yes
  register: initramfs

- name: update initramfs
  shell: update-initramfs -u
  become: yes
  become_user: ansibledaemon
  when: initramfs.changed

