- name: Enable iommu in boot efi
  replace:
   path: /boot/efi/loader/entries/Pop_OS-current.conf
   regexp: ' ro quiet loglevel='
   replace: ' ro quiet amd_iommu=on loglevel='
   owner: root
   group: root
   #backup: yes
  become: yes
  register: update_grub

- name: set up sudo for ansible user
  copy:
    src: files/vfio/vfio-pci.sh
    dest: /etc/initramfs-tools/scripts/init-top/bind_vfio.sh
    owner: root
    group: root
    mode: 0755
  register: initramfs

- name: Enable hugepages
  blockinfile:
   path: /etc/sysctl.conf
   block: |
    vm.nr_hugepages=8192
    vm.hugetlb_shm_group=48
   backup: yes
  register: initramfs

- name: update initramfs
  shell: update-initramfs -u
  become: yes
  become_user: ansibledaemon
  when: initramfs.changed

- name: update grub
  shell: update-grub
  become: yes
  become_user: ansibledaemon
  when: update_grub.changed
